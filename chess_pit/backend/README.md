# Chess Pit Backend

FastAPI-powered backend for the Chess Pit experience. The service exposes a RESTful API for
managing users, authenticating players, creating chess games, and storing moves. Data persistence is
handled through a SQLite database that lives on a bind-mounted volume so games survive container
restarts.

## Features

- FastAPI application with automatic OpenAPI/Swagger documentation at `/docs`.
- SQLite database via SQLModel (Pydantic + SQLAlchemy) with Alembic-ready metadata.
- JWT authentication using password hashing with `passlib` and token issuance via `python-jose`.
- Endpoints for:
  - Health checks.
  - User registration, profile updates, and listing.
  - Session token retrieval (`/auth/token`).
  - Creating games, recording moves, and retrieving game history.
- Pytest suite with HTTPX-powered API checks and isolated in-memory database fixtures.

## Local Development

```bash
# Install dependencies
pip install -e .[dev]

# Run the API with hot reloading
uvicorn chess_backend.main:app --reload

# Execute the test suite
pytest
```

Prefer `uv`? The project works smoothly with it as well:

```bash
uv venv
source .venv/bin/activate
uv pip install -e .[dev]
uv run uvicorn chess_backend.main:app --reload
uv run pytest
```

## Configuration

Environment variables are managed through `pydantic-settings`:

- `CHESS_DATABASE_URL` (default: `sqlite:///./data/chess.db`)
- `CHESS_SECRET_KEY` (required for token signing; autogenerated in Docker entrypoint if absent)
- `CHESS_ACCESS_TOKEN_EXPIRE_MINUTES` (default: `60`)
- `CHESS_ADMIN_USERNAME` / `CHESS_ADMIN_PASSWORD` (optional bootstrap admin credentials)
- `CHESS_RUN_MIGRATIONS` (default: `true`; set to `false` to skip automatically running Alembic at startup)

## Docker

The service is containerised via the repository-level `docker-compose.yml`. An auxiliary compose file
is available in `../docker-compose.yml` for running only the Chess Pit stack during development.
The main compose binds `./data` into the container to persist the SQLite database.

## Database Migrations

Alembic manages schema evolution for the service.

```bash
# Create a new revision after modelling changes
alembic revision --autogenerate -m "describe change"

# Apply migrations to the configured database
alembic upgrade head
```

The Alembic configuration (`alembic.ini`) reads connection details from the same environment
variables as the application, so commands run against the correct database automatically.
