version: "3.9"

networks:
  web:
    name: arcade_web
  connect4:
  solveparking:
  chesspit:
  sokoban:

services:
  traefik:
    image: traefik:v3.1
    container_name: arcade-traefik
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    networks:
      - web

  connect4-backend:
    build:
      context: ./connect_4/backend
      dockerfile: Dockerfile
    image: arcade-connect4-backend:latest
    container_name: connect4-backend
    restart: unless-stopped
    volumes:
      - /home/guillem/container_services/connect_4/data:/app/backend/data
    environment:
      - CONNECT4_DB_URL=sqlite:////app/backend/data/connect4.db
    networks:
      - connect4
    labels:
      - traefik.enable=false

  connect4-frontend:
    build:
      context: ./connect_4/frontend
      dockerfile: Dockerfile
      args:
        VITE_BACKEND_URL: /connect4/api
        VITE_BASE_PATH: /connect4/
    image: arcade-connect4-frontend:latest
    container_name: connect4-frontend
    depends_on:
      - connect4-backend
    restart: unless-stopped
    networks:
      - web
      - connect4
    labels:
      - traefik.enable=true
      - traefik.http.routers.connect4.rule=PathPrefix(`/connect4`)
      - traefik.http.routers.connect4.priority=100
      - traefik.http.routers.connect4.entrypoints=web
      - traefik.http.routers.connect4.middlewares=connect4-strip
      - traefik.http.services.connect4.loadbalancer.server.port=80
      - traefik.http.middlewares.connect4-strip.stripprefix.prefixes=/connect4

  solve-parking-backend:
    build:
      context: ./solve_parking/backend
      dockerfile: Dockerfile
    image: arcade-solve-parking-backend:latest
    container_name: solve-parking-backend
    restart: unless-stopped
    volumes:
      - /home/guillem/container_services/arcade_hub/solve_parking/puzzle_data:/app/backend/data
    networks:
      - solveparking
    labels:
      - traefik.enable=false

  solve-parking-frontend:
    build:
      context: ./solve_parking/frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: /solve-parking/api
        VITE_BASE_PATH: /solve-parking/
    image: arcade-solve-parking-frontend:latest
    container_name: solve-parking-frontend
    depends_on:
      - solve-parking-backend
    restart: unless-stopped
    networks:
      - web
      - solveparking
    labels:
      - traefik.enable=true
      - traefik.http.routers.solveparking.rule=PathPrefix(`/solve-parking`)
      - traefik.http.routers.solveparking.priority=100
      - traefik.http.routers.solveparking.entrypoints=web
      - traefik.http.routers.solveparking.middlewares=solveparking-strip
      - traefik.http.services.solveparking.loadbalancer.server.port=80
      - traefik.http.middlewares.solveparking-strip.stripprefix.prefixes=/solve-parking

  chess-backend:
    build:
      context: ./chess_pit/backend
      dockerfile: Dockerfile
    image: arcade-chess-backend:latest
    container_name: chess-backend
    restart: unless-stopped
    environment:
      - CHESS_DATABASE_URL=sqlite:////app/backend/data/chess.db
      - PATH=/host-bin:/opt/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - /home/guillem/container_services/arcade_hub/chess_pit/data:/app/backend/data
      - /home/guillem/.local/bin:/host-bin:ro
      - /home/guillem/.local/share/skaks/book:/app/backend/book:ro
    networks:
      - chesspit
    labels:
      - traefik.enable=false

  chess-frontend:
    build:
      context: ./chess_pit/frontend
      dockerfile: Dockerfile
      args:
        VITE_CHESS_API_BASE: /chess/api
        VITE_CHESS_WS_BASE: /chess/ws
        VITE_BASE_PATH: /chess/
    image: arcade-chess-frontend:latest
    container_name: chess-frontend
    depends_on:
      - chess-backend
    restart: unless-stopped
    networks:
      - web
      - chesspit
    labels:
      - traefik.enable=true
      - traefik.http.routers.chess.rule=PathPrefix(`/chess`)
      - traefik.http.routers.chess.priority=100
      - traefik.http.routers.chess.entrypoints=web
      - traefik.http.routers.chess.middlewares=chess-strip
      - traefik.http.services.chess.loadbalancer.server.port=80
      - traefik.http.middlewares.chess-strip.stripprefix.prefixes=/chess

  landing:
    build:
      context: ./landing_arcade/landing
      dockerfile: Dockerfile
    image: arcade-landing:latest
    container_name: arcade-landing
    restart: unless-stopped
    networks:
      - web
    labels:
      - traefik.enable=true
      - traefik.http.routers.landing.rule=PathPrefix(`/`)
      - traefik.http.routers.landing.priority=1
      - traefik.http.routers.landing.entrypoints=web
      - traefik.http.services.landing.loadbalancer.server.port=80

  sokoban-frontend:
    build:
      context: ./sokoban
      dockerfile: Dockerfile
      args:
        VITE_BASE_PATH: /sokoban/
    image: arcade-sokoban-frontend:latest
    container_name: sokoban-frontend
    restart: unless-stopped
    networks:
      - web
      - sokoban
    labels:
      - traefik.enable=true
      - traefik.http.routers.sokoban.rule=PathPrefix(`/sokoban`)
      - traefik.http.routers.sokoban.priority=100
      - traefik.http.routers.sokoban.entrypoints=web
      - traefik.http.services.sokoban.loadbalancer.server.port=80
      - traefik.http.routers.sokoban.service=sokoban
      - traefik.http.services.sokoban.loadbalancer.passHostHeader=true
